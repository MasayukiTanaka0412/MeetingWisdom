<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>MeetingWisdom - Transcription & Summarization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .accordion-button:focus {
        box-shadow: none;
      }
      pre {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .scrollable {
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <!-- Header -->
      <div class="text-center mb-4">
        <h1>MeetingWisdom</h1>
        <p class="lead">Real-time meeting transcription, summarization, and insights.</p>
      </div>
      
      <!-- Accordion for Settings, Help, and License -->
      <div class="accordion mb-4" id="mainAccordion">
        <!-- Settings Panel -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingSettings">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSettings" aria-expanded="false" aria-controls="collapseSettings">
              Settings (API Key, System Prompt, Language, & Model Selection)
            </button>
          </h2>
          <div id="collapseSettings" class="accordion-collapse collapse" aria-labelledby="headingSettings" data-bs-parent="#mainAccordion">
            <div class="accordion-body">
              <!-- API Key Input -->
              <div class="row mb-3">
                <div class="col-sm-4">
                  <label for="apiKeyInput" class="form-label">OpenAI API Key:</label>
                </div>
                <div class="col-sm-5">
                  <input type="password" id="apiKeyInput" class="form-control" placeholder="Your API key">
                </div>
                <div class="col-sm-3">
                  <button id="setApiKey" class="btn btn-primary w-100">Set API Key</button>
                </div>
              </div>
              
              <!-- System Prompt Multiline Textarea -->
              <div class="row mb-3">
                <div class="col-sm-4">
                  <label for="systemPromptInput" class="form-label">System Prompt:</label>
                </div>
                <div class="col-sm-5">
                  <textarea id="systemPromptInput" class="form-control" rows="3" placeholder="E.g., You are a helpful assistant that summarizes text."></textarea>
                </div>
                <div class="col-sm-3">
                  <button id="setSystemPrompt" class="btn btn-primary w-100">Set Prompt</button>
                </div>
              </div>
              
              <!-- Language Selection -->
              <div class="row mb-3">
                <div class="col-sm-4">
                  <label for="languageSelect" class="form-label">Select Language:</label>
                </div>
                <div class="col-sm-5">
                  <select id="languageSelect" class="form-select">
                    <option value="en-US">English (US)</option>
                    <option value="en-IN">English (India)</option>
                    <option value="ja-JP">Japanese</option>
                    <!-- Add more languages as needed -->
                  </select>
                </div>
                <div class="col-sm-3">
                  <button id="setLanguage" class="btn btn-primary w-100">Set Language</button>
                </div>
              </div>
              
              <!-- GPT Model Selection -->
              <div class="row mb-3">
                <div class="col-sm-4">
                  <label for="modelSelect" class="form-label">Select GPT Model:</label>
                </div>
                <div class="col-sm-5">
                  <select id="modelSelect" class="form-select">
                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                    <option value="gpt-4o">gpt-4o</option>
                    <option value="gpt-4.5-preview">gpt-4.5-preview</option>
                  </select>
                </div>
                <div class="col-sm-3">
                  <button id="setModel" class="btn btn-primary w-100">Set Model</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Help Panel -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingHelp">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHelp" aria-expanded="false" aria-controls="collapseHelp">
              Help: How to Get Your OpenAI API Key
            </button>
          </h2>
          <div id="collapseHelp" class="accordion-collapse collapse" aria-labelledby="headingHelp" data-bs-parent="#mainAccordion">
            <div class="accordion-body">
              <p>To use the OpenAI API, you'll need an API key. Follow these steps:</p>
              <ol>
                <li>
                  <strong>Sign Up / Log In:</strong> Visit the 
                  <a href="https://platform.openai.com/signup" target="_blank">OpenAI Platform</a> and create an account or log in.
                </li>
                <li>
                  <strong>Access Your Dashboard:</strong> Once logged in, go to your account dashboard.
                </li>
                <li>
                  <strong>Create a New API Key:</strong> In the API keys section, click “Create new secret key” to generate a new key.
                </li>
                <li>
                  <strong>Copy and Save:</strong> Copy the generated API key and keep it safe. Paste it into the "OpenAI API Key" input above.
                </li>
                <li>
                  Go to <a href="https://platform.openai.com/settings/organization/billing/overview">Billing</a> section and check Credit Blance is available.
                </li>
                <li>
                  <strong>Security Reminder:</strong> Do not share your API key publicly. For production, use a secure backend to proxy your API calls.
                </li>
              </ol>
              <p>Your API key will be stored in your browser's local storage for convenience.</p>
            </div>
          </div>
        </div>
        
        <!-- License Panel -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingLicense">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLicense" aria-expanded="false" aria-controls="collapseLicense">
              License (MIT)
            </button>
          </h2>
          <div id="collapseLicense" class="accordion-collapse collapse" aria-labelledby="headingLicense" data-bs-parent="#mainAccordion">
            <div class="accordion-body">
              <pre>
MIT License

Copyright (c) 2025 Masayuki Tanaka

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
              </pre>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Transcription Controls -->
      <div class="text-center mb-4">
        <button id="start" class="btn btn-success">Start Transcription</button>
        <button id="stop" class="btn btn-danger" disabled>Stop Transcription</button>
        <button id="summarize" class="btn btn-warning" >Summarize</button>
      </div>
      
      <!-- Side-by-Side Layout for Transcription and Summary -->
      <div class="row">
        <div class="col-md-6">
          <h2>Transcription</h2>
          <div id="transcript" class="border rounded p-3 scrollable"></div>
        </div>
        <div class="col-md-6">
          <h2>Summary</h2>
          <div id="summary" class="border rounded p-3 scrollable"></div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Global variables for API key, system prompt, GPT model, and language
      let apiKey = "";
      let systemPrompt = "You are a helpful assistant that summarizes text.";
      let gptModel = "gpt-4o-mini"; // default model
      let language = "en-US"; // default language
      
      // On page load, check localStorage for saved values
      window.onload = () => {
        const storedKey = localStorage.getItem("openai_api_key");
        if (storedKey) {
          apiKey = storedKey;
          document.getElementById("apiKeyInput").value = storedKey;
          console.log("API key loaded from local storage.");
        }
        const storedPrompt = localStorage.getItem("openai_system_prompt");
        if (storedPrompt) {
          systemPrompt = storedPrompt;
          document.getElementById("systemPromptInput").value = storedPrompt;
          console.log("System prompt loaded from local storage.");
        } else {
          document.getElementById("systemPromptInput").value = systemPrompt;
        }
        const storedModel = localStorage.getItem("openai_gpt_model");
        if (storedModel) {
          gptModel = storedModel;
          document.getElementById("modelSelect").value = storedModel;
          console.log("GPT model loaded from local storage.");
        }
        const storedLanguage = localStorage.getItem("speech_language");
        if (storedLanguage) {
          language = storedLanguage;
          document.getElementById("languageSelect").value = storedLanguage;
          console.log("Language loaded from local storage.");
        }
      };

      // Set API key from input and store it in localStorage
      document.getElementById("setApiKey").onclick = function() {
        const inputKey = document.getElementById("apiKeyInput").value;
        if (inputKey.trim() !== "") {
          apiKey = inputKey.trim();
          localStorage.setItem("openai_api_key", apiKey);
          alert("API Key set and saved locally!");
        } else {
          alert("Please enter a valid API key.");
        }
      };

      // Set System Prompt from input and store it in localStorage
      document.getElementById("setSystemPrompt").onclick = function() {
        const inputPrompt = document.getElementById("systemPromptInput").value;
        if (inputPrompt.trim() !== "") {
          systemPrompt = inputPrompt.trim();
          localStorage.setItem("openai_system_prompt", systemPrompt);
          alert("System Prompt set and saved locally!");
        } else {
          alert("Please enter a valid system prompt.");
        }
      };

      // Set GPT Model from select and store it in localStorage
      document.getElementById("setModel").onclick = function() {
        const selectedModel = document.getElementById("modelSelect").value;
        gptModel = selectedModel;
        localStorage.setItem("openai_gpt_model", gptModel);
        alert("GPT Model set to " + gptModel + " and saved locally!");
      };

      // Set Language from select and store it in localStorage
      // Add a language selection dropdown in the settings accordion.
      // (Assuming you have added a <select> with id="languageSelect" in your settings panel)
      if (!document.getElementById("languageSelect")) {
        // If not present, create it (for safety)
        let langDiv = document.createElement("div");
        langDiv.classList.add("row", "mb-3");
        langDiv.innerHTML = `
          <div class="col-sm-4">
            <label for="languageSelect" class="form-label">Select Language:</label>
          </div>
          <div class="col-sm-5">
            <select id="languageSelect" class="form-select">
              <option value="en-US">English (US)</option>
              <option value="en-IN">English (India)</option>
              <option value="ja-JP">Japanese</option>
            </select>
          </div>
          <div class="col-sm-3">
            <button id="setLanguage" class="btn btn-primary w-100">Set Language</button>
          </div>`;
        // Append to collapseSettings accordion body if needed.
        document.querySelector("#collapseSettings .accordion-body").appendChild(langDiv);
      }
      document.getElementById("setLanguage").onclick = function() {
        const selectedLang = document.getElementById("languageSelect").value;
        language = selectedLang;
        localStorage.setItem("speech_language", language);
        alert("Language set to " + language + " and saved locally!");
      };

      // Check for Speech Recognition support (Google Web Speech API)
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!window.SpeechRecognition) {
          alert("Your browser does not support Speech Recognition. Please use Chrome.");
      }

      // Configure SpeechRecognition
      const recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      //recognition.lang = language;  // use selected language
      
      let finalTranscript = "";
      const transcriptDiv = document.getElementById("transcript");
      const summaryDiv = document.getElementById("summary");

      recognition.onresult = (event) => {
        let interimTranscript = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript + " ";
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        transcriptDiv.innerHTML = "<p><strong>Final:</strong> " + finalTranscript + "</p>" +
                                    "<p><em>Interim:</em> " + interimTranscript + "</p>";
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
      };

      // Start and Stop Transcription Controls
      document.getElementById("start").onclick = () => {
        finalTranscript = "";
        transcriptDiv.innerHTML = "";
        summaryDiv.innerHTML = "";
        recognition.lang = language;  // use selected language
        recognition.start();
        document.getElementById("start").disabled = true;
        document.getElementById("stop").disabled = false;
        //document.getElementById("summarize").disabled = true;
      };

      document.getElementById("stop").onclick = () => {
        recognition.stop();
        document.getElementById("start").disabled = false;
        document.getElementById("stop").disabled = true;
        //document.getElementById("summarize").disabled = false;
      };

      // Call OpenAI API directly from the browser to summarize the transcript
      async function summarizeTranscript(transcript) {
        if (apiKey === "") {
          alert("Please set your OpenAI API key first.");
          return;
        }
        const url = "https://api.openai.com/v1/chat/completions";
        const data = {
          model: gptModel,
          messages: [
            { role: "system", content: systemPrompt },
            { role: "user", content: "Please summarize the following transcription:\n\n" + transcript }
          ],
          temperature: 0.7,
        };

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + apiKey,
            },
            body: JSON.stringify(data)
          });
          if (!response.ok) {
            throw new Error("API request failed with status " + response.status);
          }
          const result = await response.json();
          return result.choices[0].message.content.trim();
        } catch (error) {
          console.error("Error calling OpenAI API:", error);
          return "Error summarizing transcription.";
        }
      }

      document.getElementById("summarize").onclick = async () => {
        const summary = await summarizeTranscript(finalTranscript);
        summaryDiv.innerHTML = "<p>" + summary + "</p>";
      };
    </script>
  </body>
</html>
